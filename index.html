<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireMe.AI - 3D Authentication</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <style>
        /* ================= CYBERPUNK THEME ================= */
        :root { 
            --neon-blue: #00f3ff; 
            --neon-purple: #bc13fe; 
            --bg-dark: #050505; 
            --card-bg: rgba(20, 20, 35, 0.9);
            --text-main: #ffffff;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.1) 0%, transparent 20%);
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* LOGO */
        header { padding: 20px; text-align: center; position: absolute; top: 0; width: 100%; z-index: 100; }
        .logo { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 32px; 
            font-weight: 700; 
            color: white;
            text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
            letter-spacing: 2px;
        }

        /* ================= 3D FLIP CONTAINER ================= */
        .auth-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 550px;
            perspective: 1000px; /* Gives 3D Depth */
            z-index: 50;
        }

        .card-3d-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Class to trigger flip */
        .card-3d-wrapper.flip {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            backface-visibility: hidden; /* Hides back when rotated */
            border-radius: 20px;
            background: var(--card-bg);
            border: 1px solid rgba(0, 243, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            padding: 40px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .card-back {
            transform: rotateY(180deg); /* Start rotated */
            border-color: rgba(188, 19, 254, 0.3);
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.1);
        }

        /* FORMS */
        h2 { text-align: center; font-family: 'Orbitron'; letter-spacing: 2px; margin-bottom: 20px; }
        .glow-text-blue { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .glow-text-purple { color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple); }

        input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px;
            margin-bottom: 15px;
            color: white;
            border-radius: 8px;
            font-family: 'Outfit';
            transition: 0.3s;
        }
        input:focus { outline: none; border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }

        .btn-action {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-blue { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }
        .btn-purple { background: var(--neon-purple); color: white; box-shadow: 0 0 15px var(--neon-purple); }
        .btn-action:hover { transform: scale(1.05); }

        .switch-link {
            text-align: center; margin-top: 15px; font-size: 12px; color: var(--text-muted); cursor: pointer;
        }
        .switch-link:hover { color: white; text-decoration: underline; }

        /* ================= APP CONTAINER (HIDDEN) ================= */
        .app-container {
            display: none; /* Initially Hidden */
            width: 100%;
            height: 100%;
            padding-top: 60px;
            justify-content: center;
            align-items: center;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* SETUP & CHAT PANELS */
        .panel { 
            background: var(--card-bg); border: 1px solid var(--neon-blue); 
            padding: 30px; border-radius: 20px; width: 500px; 
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.1); 
        }
        
        .chat-panel { 
            width: 90%; max-width: 900px; height: 80vh; 
            background: rgba(10, 10, 20, 0.8); border: 1px solid var(--neon-blue); 
            border-radius: 20px; display: none; flex-direction: column; 
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .chat-window { flex: 1; padding: 20px; overflow-y: auto; }
        .message { padding: 15px; margin-bottom: 10px; border-radius: 10px; max-width: 75%; }
        .ai { background: rgba(0, 243, 255, 0.1); border-left: 3px solid var(--neon-blue); align-self: flex-start; }
        .user { background: rgba(188, 19, 254, 0.2); border-right: 3px solid var(--neon-purple); align-self: flex-end; margin-left: auto; color: white; }
        
        .input-area { padding: 20px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .chat-input { flex: 1; margin: 0; }

        .hidden { display: none !important; }
        .visible { display: flex !important; }

        /* Welcome Text */
        #welcomeUser { position: absolute; top: 25px; right: 30px; color: var(--neon-blue); font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="logo">HIREME.AI</div>
        <div id="welcomeUser"></div>
    </header>

    <!-- ================= AUTHENTICATION (3D FLIP) ================= -->
    <div class="auth-container" id="authContainer">
        <div class="card-3d-wrapper" id="cardWrapper">
            
            <!-- FRONT: LOGIN -->
            <div class="card-front">
                <h2 class="glow-text-blue">SYSTEM LOGIN</h2>
                <input type="text" id="loginUser" placeholder="Username">
                <input type="password" id="loginPass" placeholder="Password">
                <button class="btn-action btn-blue" onclick="handleLogin()">ACCESS SYSTEM</button>
                <p class="switch-link" onclick="toggleFlip()">New User? REGISTER HERE</p>
                <p id="loginMsg" style="color:red; text-align:center; font-size:12px;"></p>
            </div>

            <!-- BACK: REGISTER -->
            <div class="card-back">
                <h2 class="glow-text-purple">NEW ACCOUNT</h2>
                <input type="text" id="regName" placeholder="Full Name">
                <input type="email" id="regEmail" placeholder="Email Address">
                <input type="text" id="regUser" placeholder="Choose Username">
                <input type="password" id="regPass" placeholder="Create Password">
                <input type="password" id="regConfirm" placeholder="Confirm Password">
                <button class="btn-action btn-purple" onclick="handleRegister()">CREATE ID</button>
                <p class="switch-link" onclick="toggleFlip()">Already have an ID? LOGIN</p>
                <p id="regMsg" style="color:cyan; text-align:center; font-size:12px;"></p>
            </div>

        </div>
    </div>

    <!-- ================= MAIN APP (HIDDEN INITIALLY) ================= -->
    <div class="app-container" id="appContainer">
        
        <!-- SETUP PANEL -->
        <div class="panel" id="setupPanel">
            <h2 class="glow-text-blue">INTERVIEW PROTOCOL</h2>
            
            <label style="color:var(--neon-blue)">TARGET ROLE</label>
            <input type="text" id="jobRole" placeholder="e.g. Python Developer">

            <label style="color:var(--neon-blue)">UPLOAD RESUME</label>
            <input type="file" id="resumeFile" accept="application/pdf" style="margin-top:5px;">
            
            <p style="text-align:center; margin:10px;">-- OR --</p>
            
            <textarea id="resumeText" placeholder="Paste Resume Text..." style="width:100%; background:black; color:white; border:1px solid #333; padding:10px; height:80px;"></textarea>

            <button class="btn-action btn-blue" onclick="processAndStart()" id="startBtn">INITIALIZE AGENT</button>
            <p id="statusText" style="text-align:center; margin-top:10px; font-size:12px; color: yellow;"></p>
        </div>

        <!-- CHAT PANEL -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-window" id="chatWindow">
                <div class="message ai">Hello! I am your AI Coach. I have analyzed your profile. Ready?</div>
            </div>
            <div class="input-area">
                <input type="text" class="chat-input" id="userInput" placeholder="Type answer..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="btn-action btn-blue" style="width:60px; margin:0;" onclick="sendMessage()">âž¤</button>
            </div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const BACKEND_URL = 'http://localhost:3000';
        let sessionId = "sess-" + Date.now();

        // --- 1. 3D FLIP LOGIC ---
        function toggleFlip() {
            document.getElementById('cardWrapper').classList.toggle('flip');
            // Clear inputs
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('loginMsg').innerText = '';
            document.getElementById('regMsg').innerText = '';
        }

        // --- 2. REGISTER LOGIC ---
        async function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const username = document.getElementById('regUser').value;
            const password = document.getElementById('regPass').value;
            const confirm = document.getElementById('regConfirm').value;
            const msg = document.getElementById('regMsg');

            if (!name || !username || !password) { msg.innerText = "All fields required!"; return; }
            if (password !== confirm) { msg.innerText = "Passwords do not match!"; return; }

            try {
                const res = await fetch(`${BACKEND_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, username, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert("Registration Successful! Please Login.");
                    toggleFlip(); // Flip back to Login
                } else {
                    msg.innerText = data.message;
                }
            } catch (err) { msg.innerText = "Server Error"; }
        }

        // --- 3. LOGIN LOGIC ---
        async function handleLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const msg = document.getElementById('loginMsg');

            try {
                const res = await fetch(`${BACKEND_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    // SUCCESS: ANIMATE TRANSITION
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    document.getElementById('welcomeUser').innerText = `USER: ${data.name.toUpperCase()}`;
                } else {
                    msg.innerText = "Invalid Credentials";
                }
            } catch (err) { msg.innerText = "Server Error. Ensure backend is running."; }
        }

        // --- 4. INTERVIEW LOGIC ---
        async function processAndStart() {
            const jobRole = document.getElementById('jobRole').value;
            const fileInput = document.getElementById('resumeFile');
            const textInput = document.getElementById('resumeText').value;
            const statusFn = document.getElementById('statusText');

            if(!jobRole) return alert("Enter Job Role");

            document.getElementById('startBtn').disabled = true;
            statusFn.innerText = "SCANNING DATA...";

            let resumeText = textInput;

            if(fileInput.files[0]) {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const txt = await page.getTextContent();
                    resumeText += txt.items.map(s => s.str).join(" ");
                }
            }

            // Start Interview
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('chatPanel').style.display = 'flex';

            const initPrompt = `SYSTEM_START_INTERVIEW ROLE: ${jobRole} RESUME: ${resumeText.substring(0, 5000)}`;
            sendMessage(initPrompt, true);
        }

        async function sendMessage(textOverride = null, isHidden = false) {
            const input = document.getElementById('userInput');
            const text = textOverride || input.value;
            if(!text) return;

            if(!isHidden) {
                const div = document.createElement('div');
                div.className = 'message user';
                div.innerText = text;
                document.getElementById('chatWindow').appendChild(div);
                input.value = '';
            }

            try {
                const res = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: text, sessionId: sessionId })
                });
                const data = await res.json();

                const aiDiv = document.createElement('div');
                aiDiv.className = 'message ai';
                aiDiv.innerText = data.reply;
                document.getElementById('chatWindow').appendChild(aiDiv);
                
                // Auto Scroll
                const win = document.getElementById('chatWindow');
                win.scrollTop = win.scrollHeight;

            } catch (err) { console.error(err); }
        }
    </script>
</body>
</html>